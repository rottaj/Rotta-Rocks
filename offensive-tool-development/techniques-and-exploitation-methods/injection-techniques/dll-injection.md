---
description: >-
  DLL Injection is a technique used to run code within the address space of
  another process by forcing it to load a dynamic-link library.
---

# DLL Injection

### Creating a DLL project:

First things first, we need to have a dll to inject into a running process.

<figure><img src="../../../.gitbook/assets/Screenshot 2023-09-17 135411.png" alt=""><figcaption></figcaption></figure>

### Create header file to the DLL

We'll start by creating a header file to declare the functions our DLL exports. We'll call it _**Inject.h.**_

<figure><img src="../../../.gitbook/assets/Screenshot 2023-09-17 140724.png" alt=""><figcaption><p>This is the most basic example. We define a "INJECT_API" preprocessor macro and export "printHello" to it.</p></figcaption></figure>

### Create Source File

In our header file, we defined the preprocessor macro INJECT\_API that we want our dll to export. We'll create a source file that implements our "printHello" functionality. We'll create a new source file: _**"Inject.cpp"**_.

<figure><img src="../../../.gitbook/assets/Screenshot 2023-09-17 162539.png" alt=""><figcaption></figcaption></figure>

### DLL Implementation / Functionality

When we attach the DLL to a process we will call _**sayHello()**_ in dllmain.cpp.

<figure><img src="../../../.gitbook/assets/Screenshot 2023-09-17 162706.png" alt=""><figcaption></figcaption></figure>

### DLL Injection

To inject a DLL into a remote process we need to do the following things with their respective Windows API functions:

* Find LoadLibraryW Address (GetProcAddress)
* Open a handle to the remote process (OpenProcess)
* Allocate Memory to the remote process (VirtualAllocEx)
* Write data to the remote process. In this case the DLL's path. (WriteProcessMemory)
* Create a thread in the remote process. (CreateRemoteThread)



_**Find Load Library Address:**_

<figure><img src="../../../.gitbook/assets/Screenshot 2023-09-17 150928.png" alt=""><figcaption><p>The address stored in pLoadLibraryW will be used as the thread entry when a new thread is created in the remote process.</p></figcaption></figure>



_<mark style="color:red;">**IMPORTANT:**</mark>_ Since we are injecting into a remote process, there is no way for us to call LoadLibraryW directly within the confines of our running process. Instead we have to find the address of LoadLibraryW and pass the function as reference along with the path to our DLL (lpBuffer) as the parameter in CreateRemoteThreadEx. (As demonstrated below).



_**Allocating & Writing To Memory In Remote Process (win32calc.exe):**_

<figure><img src="../../../.gitbook/assets/Screenshot 2023-09-17 153523.png" alt=""><figcaption><p>For demonstration purposes, PATH is a command-line argument of the DLL path.</p></figcaption></figure>

<figure><img src="../../../.gitbook/assets/Screenshot 2023-09-17 153326.png" alt=""><figcaption></figcaption></figure>

_**Execution Via New Thread:**_

<figure><img src="../../../.gitbook/assets/Screenshot 2023-09-17 163017.png" alt=""><figcaption><p>We call pLoadLibraryW with the path to our DLL (lpBuffer)</p></figcaption></figure>
